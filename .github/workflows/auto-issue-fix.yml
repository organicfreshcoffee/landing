name: Auto Issue Fix with Claude

on:
  schedule:
    # Run daily at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  auto-fix-issue:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ./client/package-lock.json
          ./server/package-lock.json
    
    - name: Install client dependencies
      run: |
        cd client
        npm ci
    
    - name: Install server dependencies
      run: |
        cd server
        npm ci
    
    - name: Install script dependencies
      run: |
        npm install @anthropic-ai/sdk octokit
    
    - name: Configure Git
      run: |
        git config --global user.name "Auto Issue Bot"
        git config --global user.email "bot@organicfreshcoffee.com"
    
    - name: Run auto issue fix script
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: node scripts/auto-issue-fix.js
    
    - name: Check if changes were made
      id: check_changes
      run: |
        if git diff --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Pull Request
      if: steps.check_changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: auto-fix/issue-${{ github.run_number }}
        commit-message: "Auto-fix: Resolve issue identified by Claude AI"
        title: "ðŸ¤– Auto-fix: Issue resolution by Claude Haiku 3.5"
        body: |
          This pull request was automatically generated by Claude Haiku 3.5 AI to fix an open issue.
          
          ## Summary
          Claude analyzed the open issues and identified the easiest one to fix, then implemented a solution.
          
          ## Changes Made
          - Automated issue analysis and resolution
          - Code changes generated by Claude Haiku 3.5
          
          ## Testing
          Please review the changes and test thoroughly before merging.
          
          ---
          *This PR was created automatically by the Auto Issue Fix workflow*
        assignees: ${{ github.actor }}
        reviewers: ${{ github.actor }}
