name: Auto Issue Fix with Claude

on:
  schedule:
    # Run daily at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  auto-fix-issue:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          ./client/package-lock.json
          ./server/package-lock.json
    
    - name: Install client dependencies
      run: |
        cd client
        npm ci
    
    - name: Install server dependencies
      run: |
        cd server
        npm ci
    
    - name: Install script dependencies
      run: |
        npm install @anthropic-ai/sdk octokit
    
    - name: Configure Git
      run: |
        git config --global user.name "Auto Issue Bot"
        git config --global user.email "bot@organicfreshcoffee.com"
    
    - name: Run auto issue fix script
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: node scripts/auto-issue-fix.js
    
    - name: Check if changes were made
      id: check_changes
      run: |
        if git diff --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Read issue details
      id: issue_details
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        if [ -f "issue-fix-details.json" ]; then
          # Read the JSON file and extract key information
          ISSUE_NUMBER=$(jq -r '.number' issue-fix-details.json)
          ISSUE_TITLE=$(jq -r '.title' issue-fix-details.json)
          ISSUE_BODY=$(jq -r '.body' issue-fix-details.json)
          ISSUE_URL=$(jq -r '.url' issue-fix-details.json)
          ISSUE_USER=$(jq -r '.user' issue-fix-details.json)
          SOLUTION_DESC=$(jq -r '.solution_description' issue-fix-details.json)
          TESTING_NOTES=$(jq -r '.testing_notes' issue-fix-details.json)
          FILES_MODIFIED=$(jq -r '.files_modified' issue-fix-details.json)
          CONFIDENCE=$(jq -r '.confidence' issue-fix-details.json)
          
          # Set outputs (escape newlines and quotes for GitHub Actions)
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
          echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
          echo "issue_user=$ISSUE_USER" >> $GITHUB_OUTPUT
          echo "solution_desc=$SOLUTION_DESC" >> $GITHUB_OUTPUT
          echo "testing_notes=$TESTING_NOTES" >> $GITHUB_OUTPUT
          echo "files_modified=$FILES_MODIFIED" >> $GITHUB_OUTPUT
          echo "confidence=$CONFIDENCE" >> $GITHUB_OUTPUT
          
          # Handle multi-line issue body
          {
            echo 'issue_body<<EOF'
            echo "$ISSUE_BODY"
            echo EOF
          } >> $GITHUB_OUTPUT
        else
          echo "No issue details found"
        fi
    
    - name: Create Pull Request
      if: steps.check_changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: auto-fix/issue-${{ github.run_number }}
        commit-message: "Auto-fix: Resolve issue identified by Claude AI"
        title: "🤖 Auto-fix: Issue #${{ steps.issue_details.outputs.issue_number }} - ${{ steps.issue_details.outputs.issue_title }}"
        body: |
          This pull request was automatically generated by Claude Haiku 3.5 AI to fix an open issue.
          
          ## 🎯 Issue Fixed
          **Issue #${{ steps.issue_details.outputs.issue_number }}**: [${{ steps.issue_details.outputs.issue_title }}](${{ steps.issue_details.outputs.issue_url }})
          
          **Original Description:**
          > ${{ steps.issue_details.outputs.issue_body }}
          
          **Reported by:** @${{ steps.issue_details.outputs.issue_user }}
          
          ## 🔧 Solution Implemented
          ${{ steps.issue_details.outputs.solution_desc }}
          
          ## 📊 Fix Details
          - **Confidence Level:** ${{ steps.issue_details.outputs.confidence }}
          - **Files Modified:** ${{ steps.issue_details.outputs.files_modified }}
          - **AI Model:** Claude Haiku 3.5
          
          ## 🧪 Testing Notes
          ${{ steps.issue_details.outputs.testing_notes }}
          
          ## ⚠️ Review Required
          Please review the changes carefully and test thoroughly before merging. This is an automated fix and may require adjustments.
          
          ---
          *This PR was created automatically by the Auto Issue Fix workflow*
        assignees: ${{ github.actor }}
        reviewers: ${{ github.actor }}
